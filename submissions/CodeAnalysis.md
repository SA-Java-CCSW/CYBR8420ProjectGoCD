## Code Review Strategy
Before diving into the detailed code analysis, we did a manual coarse-grained scan of GoCD's code base to see if there is any existance of most popular CWEs(Commone Weakness Enumeration) such as CWE-120/CWE-798/CWE-311/CWE-434/CWE-250/CWE-494/CWE-22/CWE-759. 

**CWE-120: Classic buffer overflow**
It seems that the chance of popular classic buffer overflow (CWE-120) in Java is very small unless JNI(Java Native Interface) is used to call native codes written in c/c++. See https://stackoverflow.com/questions/479701/does-java-have-buffer-overflows. Searches for keyword "native"  and "System.loadLibrary" under top-level gocd directory did not show any usage of JNI in GoCD. Therefore, GoCD does not seem to have CWE-120 issue.

**CWE-798 issue: Use of hardcoded credentials**
Search with command ( grep -R "password"|less ) showed many hardcoded credentials usage, but most of them are from source codes written to test GoCD's functionalities. The only concern we have found is use of hardcoded credentials in source file [SystemEnvironment.java](https://github.com/gocd/gocd/blob/master/base/src/main/java/com/thoughtworks/go/util/SystemEnvironment.java):  
public static GoSystemProperty<String> GO_AGENT_KEYSTORE_PASSWORD = new GoStringSystemProperty("go.agent.keystore.password", "agent5s0repa55w0rd");  
public static GoSystemProperty<String> GO_SERVER_KEYSTORE_PASSWORD = new GoStringSystemProperty("go.server.keystore.password", "serverKeystorepa55w0rd");  
 Therefore, GoCD seems to have some CWE-798 issue.
 
 **CWE-311: Missing encryption**  
 TBD
 
 **CWE-434: Unrestricted upload of file with dangerous type**  
By scanning output of 'grep -R upload|less' it seems that GoCD does not allow users to upload any files from its web GUI. The only file uploading feature in GoCD is to upload Artifact files generated by jobs on Go Agents to the predefined Artifact directory on Go Server. So, The issue of CWE-434 does not apply in GoCD.

**CWE-250: Execution with unnecessary privileges**  
TBD

**CWE-494: Download of code without integrity check**  
By scanning output of 'grep -R checksum|less' it seems that GoCD does use MD5 checksum to check integrity of all artifact files before using them. So, GoCD has taken care of issue CWE-494.

**CWE-22: Path traversal**  
By scanning output of 'grep -R path|less' it seems that there are many references to controllerBasePath() and scanning output of 'grep -R controllerBasePath|less' seems to show many GoCD's web GUI URLs for different controllers are defined in source file [Routes.java](https://github.com/gocd/gocd/blob/master/spark/spark-base/src/main/java/com/thoughtworks/go/spark/Routes.java). For example, the following codes defined URLs of login and logout pages:  
    public class LoginPage {  
        public static final String SPA_BASE = "/auth/login";  
    }  
    public class LogoutPage {  
        public static final String SPA_BASE = "/auth/logout";  
    }  
Therefore, GoCD does not seem to have CWE-22 issue.  
 
**CWE-759: Use of one-way hash without a salt**  
It seems that method hashCode() in source file [UsernamePassword.java](https://github.com/gocd/gocd/blob/master/server/src/main/java/com/thoughtworks/go/server/newsecurity/models/UsernamePassword.java) violates CWE-759.

Then we started with reviewing our assurance cases, misuse cases, and threat model report. From the review, we discovered the most critical weakness areas in the software and decided to choose the checklist review strategy which is the most appropriate method for analyzing the code of large-scale projects like GoCD. To reduce the effort of going through all the codes for each line we decided to review all 12 items from our [checklist](https://github.com/SA-Java-CCSW/CYBR8420ProjectGoCD/blob/master/CodeReview/Checklist.md).

**Checklist item 1**  
Looks like [AuthenticationController.java](https://github.com/gocd/gocd/blob/master/server/src/main/java/com/thoughtworks/go/server/newsecurity/controllers/AuthenticationController.java) is the main source code for user login authentication in GoCD.  
Method performLogin() use local password file based authentication plugin to authenticate user login.  
Method redirectToThirdPartyLoginPage() redirect user's login request to proper third party login page based on the third party authentication plugin ID "pluginId".  
Method authenticateWithWebBasedPlugin() use proper third party authentication plugin to authenticate user login.  
It seems that GoCD does not support user account lockout after N unsuccessful login attempts. It only calls method badAuthentication() to show message "Invalid credentials. Either your username and password are incorrect, or there is a problem with your browser cookies. Please check with your administrator." when authentication fails.  
Method isSecurityEnabled() in [SecurityService.java](https://github.com/gocd/gocd/blob/master/server/src/main/java/com/thoughtworks/go/server/service/SecurityService.java) and [GoConfigService.java](https://github.com/gocd/gocd/blob/master/server/src/main/java/com/thoughtworks/go/server/service/GoConfigService.java) is to check if authentication has been enabled or not. By default authentication service is not enabled on a newly installed GoCD Server (See https://docs.gocd.org/current/configuration/dev_authentication.html).  
Many GoCD system environment constants are defined in source file [SystemEnvironment.java](https://github.com/gocd/gocd/blob/master/base/src/main/java/com/thoughtworks/go/util/SystemEnvironment.java).  
Looks like GoCD does not support IP range based ACL(Access Control List) even though there is a class called "GoAcl" in [GoAcl.java](https://github.com/gocd/gocd/blob/master/server/src/main/java/com/thoughtworks/go/server/security/GoAcl.java) which only determines if a username is contained in a list of authorizedUsers. It is used in method readAclBy() in [GoConfigService.java](https://github.com/gocd/gocd/blob/master/server/src/main/java/com/thoughtworks/go/server/service/GoConfigService.java) to create a list of authorizedUsers to access a particular stage of some pipeline. In addition, it is used in method hasOperatePermissionForStage() in [SecurityService.java](https://github.com/gocd/gocd/blob/master/server/src/main/java/com/thoughtworks/go/server/service/SecurityService.java) to determine if a particular user has operate permission for a particular stage of some pipeline.

**Checklist item 2**   
TBD

**Checklist item 3**  
BackupsController.java is the main source code for user to perform the backup process in GoCD.
setupRoutes method handles backup content type, verify backup confirm and authentication processes.
create method handles request and response. Backup server runs based on the current user name and inform user the backup result.
verifyConfirmHeader method verify request to see if it is satisfied in certain condition.
backupConfigRepresenter.java is code that allows user to configure backup settings for the GoCD server.
toJSON method and fromJSON method contain JSON object with information that lets user know about backup process is success or not.

**Checklist item 4**  
TBD

**Checklist item 5**  
TBD

**Checklist item 6**  
TBD

**Checklist item 7**  
ServerMaintenanceModeControllerv1.java is the main source code to determine which the internal subsystems and processes continue to work.
enableMaintenanceModeState method handles the existing maintenance mode state and notice user with certain information by checking the existingMaintenanceModeState first to see if the server is available in maintenance mode. 
Comparing to the enableMaintenanceModestate method, disableMaintenanceModeState method works in the opposite way, it handles the existing maintenance mode state and notice user with certain information if the server is available.
getRunningJobs method return information about the current running job instances. In the method, each running pipe line instance in the GoDashboardPipeline is collected and return as a list object.

**Checklist item 8**  
TBD

**Checklist item 9**  
It seems that authorization component of GoCD mainly involves two source files: [SecurityService.java](https://github.com/gocd/gocd/blob/master/server/src/main/java/com/thoughtworks/go/server/service/SecurityService.java) and [GoConfigService.java](https://github.com/gocd/gocd/blob/master/server/src/main/java/com/thoughtworks/go/server/service/GoConfigService.java).  
Based on method isAdmin() in [SecurityConfig.java](https://github.com/gocd/gocd/blob/master/config/config-api/src/main/java/com/thoughtworks/go/config/SecurityConfig.java) there are three ways to get Administrator permission in GoCD:  
!isSecurityEnabled() means no authentication is enabled after initial GoCD installation by default.  
noAdminsConfigured() means no user is assigned Administrator role by default.  
adminsConfig.isAdmin(admin, rolesConfig.memberRoles(admin)) means the user is a member of Administrator role.  
This is consistent with GoCD's documentation https://docs.gocd.org/current/configuration/dev_authorization.html .  
Therefore, a new user is actually given Administrator permission if none of existing users has been assigned as Administrator role.  

**Checklist item 10**  
TBD

**Checklist item 11**  
TBD

**Checklist item 12**  
AgentsControllerV6.java is the main source code to allow users with administrator role to manage agents.
update method determines agent’s update action of agent with its id. If the updateAgentAttributes successfully update the agent’s attribute, then call the handleUpdateAgentResponse method. Exception will be handled if the update attribute method throws exception.
bulkUpdate method handles attribute update of agent with certain id. If the update action is successfully finished, text explanation is printed out. Otherwise, exception is handled.
deleteAgents method accepts request to handle deletion of specific agent with text explanation if no exception occurs.
checkSecurityOr403 method handles GET request with apiAuthenticationHelper component.
handleCreateOrUpdateResponse method handles response of new agent’s register or update status’s of existing agent.
handleUpdateAgentResponse method handles response of specific agent’s update status and inform user with text explanation. 


We analyzed our code in both automated and manual review process. The automated code review is performed using open source static code analysis tool called **PWD and Findbugs**. The list of resultant vulnerabilities from the automated tool scan was narrowed  down to analyze  **CWE(Common Weakness Enumeration)** that are related to our misuse case, assurance cases, and threat model and examined manually.

## Manual Code Review

## Automated Tool Scan
After exploring the DHS SWAMP scanning platform we attempted to use the system to scan the GoCD Java code files.  We did use the SWAMP platform to scan the Java Bytecode with Findbugs 3.0.1.  We also used the PMD 6.9.0 tool to scan the Java code files.

#### Findbugs 3.0.1
This tool was used in the SWAMP platform to scan the GoCD Java Bytecode.  

#### PMD 6.9.0
The most recent version of the PMD tool was just downloaded locally to a Linux host and ran against the GoCD codebase.

### Project Links
* Team Repository: https://github.com/SA-Java-CCSW/CYBR8420ProjectGoCD
* Project Board: https://github.com/SA-Java-CCSW/CYBR8420ProjectGoCD/projects/5
